<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>Plug & Pause â€“ Firma J</title>
  <script type="module" src="widget.js?companyId=FIRMAJ&v=5"></script>


  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }

    #widget {
      border: 1px solid #ccc;
      padding: 20px;
      width: 100%;
      margin-bottom: 40px;
      border-radius: 8px;
    }

    #feed div {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      font-size: 15px;
    }

    h2 {
      margin-top: 40px;
    }

    #toggleMuteBtn {
      margin-top: 10px;
    }
  </style>
</head>

<body>

  <h1>Plug & Pause â€“ Firma J</h1>

  <!-- Widget container -->
  <div id="widget">
    <button id="rollBtn">Rul terning</button>
    <p id="aktivitet">â€“</p>
    <button id="doneBtn">FÃ¦rdig</button>
    <p id="status"></p>
  </div>

  <!-- Navn -->
  <label for="username">Dit navn:</label>
  <input id="username" type="text" placeholder="Skriv dit navn">
  <button id="saveNameBtn">Gem navn</button>
  <p id="nameStatus"></p>

  <!-- Mute-knap -->
  <button id="toggleMuteBtn">SlÃ¥ pÃ¥mindelser fra</button>
  <p id="muteStatus"></p>

  <!-- Socialt feed -->
  <h2>Socialt feed</h2>
  <div id="feed">IndlÃ¦serâ€¦</div>

  <!-- Widget script -->
  <script type="module">
    import { sendSocialEvent, sendPause, getCompanyId, getOrCreateUserId, rulTerning } from "./widget.js";

    // ---------------------------------------------------------
    // NAVN
    // ---------------------------------------------------------
    const nameInput = document.getElementById("username");
    const saveNameBtn = document.getElementById("saveNameBtn");
    const nameStatus = document.getElementById("nameStatus");

    const savedName = localStorage.getItem("pp_name");
    if (savedName) {
      nameInput.value = savedName;
      nameStatus.textContent = "Navn gemt: " + savedName;
    }

    saveNameBtn.onclick = () => {
      const name = nameInput.value.trim();
      if (name.length < 2) {
        nameStatus.textContent = "Navnet er for kort";
        return;
      }
      localStorage.setItem("pp_name", name);
      nameStatus.textContent = "Navn gemt: " + name;
    };


    // ---------------------------------------------------------
    // FEED
    // ---------------------------------------------------------
    async function loadFeed() {
      const companyId = "FIRMAJ";

      const res = await fetch(
        `https://plugandpause-backend.jakobhelkjaer.workers.dev/api/feed?groupId=${companyId}`
      );

      const events = await res.json();
      const feedDiv = document.getElementById("feed");
      feedDiv.innerHTML = "";

      if (events.length === 0) {
        feedDiv.textContent = "Ingen aktiviteter endnu.";
        return;
      }

      events.forEach(ev => {
        const displayName = ev.name || ev.userId;
        const time = new Date(ev.timestamp).toLocaleTimeString("da-DK");
        const item = document.createElement("div");
        item.textContent = `${time} â€“ ${displayName} lavede: ${ev.activity}`;
        feedDiv.appendChild(item);
      });
    }

    loadFeed();
    setInterval(loadFeed, 10000);


    // ---------------------------------------------------------
    // PÃ…MINDELSER
    // ---------------------------------------------------------
    if (!localStorage.getItem("pp_mute")) {
      localStorage.setItem("pp_mute", "false");
    }

    const morningReminder = { hour: 10, minute: 0 };
    const afternoonReminder = { hour: 14, minute: 30 };

    function resetDailyFlags() {
      const today = new Date().toDateString();
      const last = localStorage.getItem("pp_lastReminderDate");

      if (today !== last) {
        localStorage.setItem("pp_lastReminderDate", today);
        localStorage.setItem("pp_morningDone", "false");
        localStorage.setItem("pp_afternoonDone", "false");
      }
    }

    resetDailyFlags();

    function checkReminder(target, flagName) {
      if (localStorage.getItem("pp_mute") === "true") return;

      const now = new Date();
      if (localStorage.getItem(flagName) === "true") return;

      if (now.getHours() === target.hour && now.getMinutes() === target.minute) {
        alert("Tid til en lille pause! Rul terningen ðŸ˜Š");
        localStorage.setItem(flagName, "true");
      }
    }

    setInterval(() => {
      resetDailyFlags();
      checkReminder(morningReminder, "pp_morningDone");
      checkReminder(afternoonReminder, "pp_afternoonDone");
    }, 60000);


    // ---------------------------------------------------------
    // MUTE-KNAP
    // ---------------------------------------------------------
    const muteBtn = document.getElementById("toggleMuteBtn");
    const muteStatus = document.getElementById("muteStatus");

    function updateMuteUI() {
      const muted = localStorage.getItem("pp_mute") === "true";
      muteBtn.textContent = muted ? "SlÃ¥ pÃ¥mindelser til" : "SlÃ¥ pÃ¥mindelser fra";
      muteStatus.textContent = muted ? "PÃ¥mindelser er slÃ¥et fra" : "PÃ¥mindelser er aktive";
    }

    muteBtn.onclick = () => {
      const current = localStorage.getItem("pp_mute") === "true";
      localStorage.setItem("pp_mute", current ? "false" : "true");
      updateMuteUI();
    };

    updateMuteUI();


    // ---------------------------------------------------------
    // WIDGET-KNAPPER
    // ---------------------------------------------------------
    let currentActivity = null;

    document.getElementById("rollBtn").onclick = () => {
      currentActivity = rulTerning();
      document.getElementById("aktivitet").textContent = currentActivity;
    };

    document.getElementById("doneBtn").onclick = async () => {
      const companyId = getCompanyId();
      const userId = getOrCreateUserId();
      const name = localStorage.getItem("pp_name") || null;

      await sendPause(userId, companyId);
      await sendSocialEvent(companyId, userId, currentActivity, name);

      document.getElementById("status").textContent = "Pause registreret!";
    };
  </script>

</body>
</html>

