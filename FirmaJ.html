<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>Plug & Pause – Firma J</title>

  <!-- Loader widget.js med companyId -->
  <script type="module" src="widget.js?companyId=FIRMAJ"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }

    #widget {
      border: 1px solid #ccc;
      padding: 20px;
      width: 100%;
      margin-bottom: 40px;
      border-radius: 8px;
    }

    #feed div {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      font-size: 15px;
    }

    h2 {
      margin-top: 40px;
    }

    #toggleMuteBtn {
      margin-top: 10px;
    }

    #reminderBox {
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 8px;
      margin-top: 30px;
    }
  </style>
</head>

<body>

  <h1>Plug & Pause – Firma J</h1>

  <!-- Widget container -->
  <div id="widget">
    <button id="rollBtn">Rul terning</button>
    <p id="aktivitet">–</p>
    <button id="doneBtn">Færdig</button>
    <p id="status"></p>
  </div>

  <!-- Navn -->
  <label for="username">Dit navn:</label>
  <input id="username" type="text" placeholder="Skriv dit navn">
  <button id="saveNameBtn">Gem navn</button>
  <p id="nameStatus"></p>

  <!-- Mute-knap -->
  <button id="toggleMuteBtn">Slå påmindelser fra</button>
  <p id="muteStatus"></p>

  <!-- Reminder UI -->
  <div id="reminderBox">
    <h2>Påmindelse</h2>
    <label for="reminderTime">Vælg tidspunkt:</label>
    <input type="time" id="reminderTime">
    <button id="saveReminderBtn">Gem påmindelse</button>
    <p id="reminderStatus"></p>
  </div>

  <!-- Socialt feed -->
  <h2>Socialt feed</h2>
  <div id="feed">Indlæser…</div>

  <!-- Widget script -->
  <script type="module">
    import {
      sendSocialEvent,
      sendPause,
      getCompanyId,
      getOrCreateUserId,
      rulTerning
    } from "./widget.js?companyId=FIRMAJ";

    // ---------------------------------------------------------
    // NAVN
    // ---------------------------------------------------------
    const nameInput = document.getElementById("username");
    const saveNameBtn = document.getElementById("saveNameBtn");
    const nameStatus = document.getElementById("nameStatus");

    const savedName = localStorage.getItem("pp_name");
    if (savedName) {
      nameInput.value = savedName;
      nameStatus.textContent = "Navn gemt: " + savedName;
    }

    saveNameBtn.onclick = () => {
      const name = nameInput.value.trim();
      if (name.length < 2) {
        nameStatus.textContent = "Navnet er for kort";
        return;
      }
      localStorage.setItem("pp_name", name);
      nameStatus.textContent = "Navn gemt: " + name;
    };


    // ---------------------------------------------------------
    // FEED
    // ---------------------------------------------------------
    async function loadFeed() {
      const companyId = "FIRMAJ";

      const res = await fetch(
        `https://plugandpause-backend.jakobhelkjaer.workers.dev/api/feed?groupId=${companyId}`
      );

      const events = await res.json();
      const feedDiv = document.getElementById("feed");
      feedDiv.innerHTML = "";

      if (events.length === 0) {
        feedDiv.textContent = "Ingen aktiviteter endnu.";
        return;
      }

      events.forEach(ev => {
        const displayName = ev.name || ev.userId;
        const time = new Date(ev.timestamp).toLocaleTimeString("da-DK");
        const item = document.createElement("div");
        item.textContent = `${time} – ${displayName} lavede: ${ev.activity}`;
        feedDiv.appendChild(item);
      });
    }

    loadFeed();
    setInterval(loadFeed, 10000);


    // ---------------------------------------------------------
    // MUTE-KNAP
    // ---------------------------------------------------------
    const muteBtn = document.getElementById("toggleMuteBtn");
    const muteStatus = document.getElementById("muteStatus");

    function updateMuteUI() {
      const muted = localStorage.getItem("pp_mute") === "true";
      muteBtn.textContent = muted ? "Slå påmindelser til" : "Slå påmindelser fra";
      muteStatus.textContent = muted ? "Påmindelser er slået fra" : "Påmindelser er aktive";
    }

    muteBtn.onclick = () => {
      const current = localStorage.getItem("pp_mute") === "true";
      localStorage.setItem("pp_mute", current ? "false" : "true");
      updateMuteUI();
    };

    updateMuteUI();


    // ---------------------------------------------------------
    // REMINDER UI → EXTENSION
    // ---------------------------------------------------------
    const reminderInput = document.getElementById("reminderTime");
    const saveReminderBtn = document.getElementById("saveReminderBtn");
    const reminderStatus = document.getElementById("reminderStatus");

    const savedTime = localStorage.getItem("reminderTime");
    if (savedTime) reminderInput.value = savedTime;

    saveReminderBtn.onclick = () => {
      const time = reminderInput.value;
      if (!time) {
        reminderStatus.textContent = "Vælg et tidspunkt først";
        return;
      }

      localStorage.setItem("reminderTime", time);
      reminderStatus.textContent = "Påmindelse gemt: " + time;

      chrome.runtime.sendMessage({
        type: "SET_REMINDER",
        time: time,
        companyId: "FIRMAJ"
      });
    };


    // ---------------------------------------------------------
    // WIDGET-KNAPPER
    // ---------------------------------------------------------
    let currentActivity = null;

    document.getElementById("rollBtn").onclick = () => {
      currentActivity = rulTerning();
      document.getElementById("aktivitet").textContent = currentActivity;
    };

    document.getElementById("doneBtn").onclick = async () => {
      const companyId = getCompanyId();
      const userId = getOrCreateUserId();
      const name = localStorage.getItem("pp_name");

      await sendPause(userId, companyId);
      await sendSocialEvent(companyId, userId, currentActivity, name);

      document.getElementById("status").textContent = "Pause registreret!";
    };
  </script>

</body>
</html>
